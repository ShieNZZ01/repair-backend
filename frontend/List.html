<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
  <link rel="stylesheet" href="/frontend/list-style.css" />
</head>
<body>
  <div class="container">
    <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>

    <div class="btn-right">
      <button class="btn-primary" onclick="window.location.href='./RoleSelect.html'">
        üîô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      </button>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." />
    </div>

    <table id="repairTable">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</th>
          <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ‚úÖ Modal popup -->
  <div id="modalOverlay" class="modal-overlay"></div>
  <div id="modalBox" class="modal">
    <div id="modalContent"></div>
    <button class="modal-close" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
  </div>

<script>
let allData = [];

const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get("role");
const reporter = urlParams.get("reporter");

let apiUrl = "http://localhost:3000/api/requests";
if (role !== "admin" && reporter) {
  apiUrl += `?reporter=${encodeURIComponent(reporter)}`;
}

function formatThaiDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'});
}

function highlight(text, keyword) {
  if (!keyword) return text;
  const regex = new RegExp(`(${keyword})`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

function showModal(content) {
  document.getElementById('modalContent').innerHTML = content;
  document.getElementById('modalOverlay').style.display = 'block';
  document.getElementById('modalBox').style.display = 'block';
}
function closeModal() {
  document.getElementById('modalOverlay').style.display = 'none';
  document.getElementById('modalBox').style.display = 'none';
}

async function loadData() {
  try {
    let headers = {};
    if (role === "admin") {
      const token = sessionStorage.getItem('token');
      if (!token) {
        alert('‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        window.location.href = './RoleSelect.html';
        return;
      }
      headers = { 'Authorization': 'Bearer ' + token };
    }

    const resp = await fetch(apiUrl,{headers});
    if (!resp.ok) {
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      return;
    }
    const data = await resp.json();
    allData = Array.isArray(data) ? data : [];
    renderTable(allData);
  } catch (e) {
    alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    console.error(e);
  }
}

function renderTable(data) {
  const keyword = document.getElementById('searchInput').value.toLowerCase();
  const tbody = document.querySelector('#repairTable tbody');
  tbody.innerHTML = '';

  data.forEach((item, index) => {
    const row = document.createElement('tr');
    row.className = index % 2 === 0 ? 'row-dark' : 'row-light';

    const tdReporter = document.createElement('td');
    tdReporter.innerHTML = highlight(item.reporter || '-', keyword);

    const tdProblem = document.createElement('td');
    tdProblem.innerHTML = highlight(item.problem || '-', keyword);

    const tdDevice = document.createElement('td');
    tdDevice.textContent = item.device || '-';

    const tdDate = document.createElement('td');
    tdDate.textContent = item.date ? formatThaiDate(item.date) : '-';

    const tdStatus = document.createElement('td');
    const tdDetail = document.createElement('td');

    if (role === "admin") {
      const statusSelect = document.createElement('select');
      statusSelect.className = 'status-select'; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

      ['‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£','‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'].forEach(status=>{
        const option=document.createElement('option');
        option.value=status;
        option.textContent=status;
        if(item.status===status) option.selected=true;
        statusSelect.appendChild(option);
      });

      statusSelect.addEventListener('change', async ()=>{
        try {
          const token = sessionStorage.getItem('token');
          const res = await fetch(`http://localhost:3000/api/requests/${item.id || item._id}`,{
            method:'PATCH',
            headers:{
              'Content-Type':'application/json',
              'Authorization':'Bearer '+token
            },
            body:JSON.stringify({status:statusSelect.value})
          });
          if(!res.ok) throw new Error('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } catch(err) {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
          console.error(err);
        }
      });

      tdStatus.appendChild(statusSelect);
    } else {
      tdStatus.textContent = item.status || '-';
    }

    const detailBtn=document.createElement('button');
    detailBtn.textContent='‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
    detailBtn.className='btn-detail';
    detailBtn.addEventListener('click',()=>{
      showModal(`
        <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${item.reporter}<br>
        <strong>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</strong> ${item.device}<br>
        <strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${item.problem}<br>
        <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${item.status}<br>
        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á:</strong> ${item.date ? formatThaiDate(item.date) : '-'}
      `);
    });
    tdDetail.appendChild(detailBtn);

    row.appendChild(tdReporter);
    row.appendChild(tdProblem);
    row.appendChild(tdDevice);
    row.appendChild(tdDate);
    row.appendChild(tdStatus);
    row.appendChild(tdDetail);

    tbody.appendChild(row);
  });
}


document.getElementById('searchInput').addEventListener('input',()=>{
  const keyword=document.getElementById('searchInput').value.toLowerCase();
  const filtered=allData.filter(item=>
    item.reporter?.toLowerCase().includes(keyword) ||
    item.problem?.toLowerCase().includes(keyword)
  );
  renderTable(filtered);
});

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
